name: 同步ok

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: '强制同步'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-from-c-to-b:
    name: 同步ok
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出B仓库的okjack分支
      uses: actions/checkout@v4
      with:
        ref: okjack
        fetch-depth: 1
      continue-on-error: true
    
    - name: 初始化仓库
      if: steps.checkout.outcome == 'failure'
      run: |
        git init
        git remote add origin https://github.com/${{ github.repository }}.git
        git config user.name "GitHub Actions Bot"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -b okjack
    
    - name: 添加C仓库作为上游远程仓库
      run: |
        git remote remove upstream-c 2>/dev/null || true
        git remote add upstream-c https://github.com/lystv/fmapp.git
        git fetch upstream-c ok --depth=1
    
    - name: 检查是否有更新
      id: check_update
      run: |
        if git rev-parse HEAD >/dev/null 2>&1; then
          if git diff --quiet HEAD upstream-c/ok 2>/dev/null; then
            echo "has_update=false" >> $GITHUB_OUTPUT
          else
            echo "has_update=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_update=true" >> $GITHUB_OUTPUT
        fi
    
    - name: 重置到C仓库的ok分支
      if: steps.check_update.outputs.has_update == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        git reset --hard upstream-c/ok
    
    - name: 强制推送到B仓库的okjack分支
      if: steps.check_update.outputs.has_update == 'true' || github.event.inputs.force_sync == 'true'
      run: |
        git push origin okjack --force
